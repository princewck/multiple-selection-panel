"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var n=0,t=Array(e.length);n<e.length;n++)t[n]=e[n];return t}return Array.from(e)}angular.module("ck.directives",[]).directive("selectPanel",["$parse","$timeout",function(e,n){return{restrict:"E",require:"ngModel",templateUrl:"select-panel/template.html",link:function(t,a,s,c){t.directiveId=t.$id,t.wrapperId="ck-select-panel"+t.$id;var l="true"==s.cascade;t.cascade=l||!1,t.searchPanelVisible=s.hasOwnProperty("static")||!1,t.togglePanelVisiblity=function(e){e.stopPropagation(),s.hasOwnProperty("static")||(t.searchPanelVisible=!t.searchPanelVisible)};var i=function(e){e.stopPropagation(),t.searchPanelVisible&&t.$apply(t.searchPanelVisible=!1)};t.noHide=function(e){e.stopPropagation()},t.staticMode=function(){return s.hasOwnProperty("static")},s.hasOwnProperty("static")||(document.addEventListener("click",i),t.$on("$destory",function(){document.removeEventListener("click",i)}));for(var r=angular.isString(s.arrayKeys)?s.arrayKeys.trim().split("=>"):[],o=r.length+1,d=[],u=0;u<o;u++)d.push("name");t.nameKeys=s.hasOwnProperty("nameKeys")?s.nameKeys.split(","):d;e(s.ngModel)(t.$parent);t.selectedItems={};var m=[],p=t.data,g=function(e){for(var n={},a=p,s=0;s<e;s++){if(!(n=a[t.selectedItems[s]||0]))return m;a=n[r[s]]||m}return a};t.flatItems=[],t.$watch("data",function(e,n){p=angular.copy(e),t.flatItems=h(p)});var h=function(e){for(var n=e,t=0;t<o-1;t++)!function(e){var t=[];n.forEach(function(n,a){n.tree=n.tree||[],n.tree.push(e+","+a),n.tree=[].concat(_toConsumableArray(new Set(n.tree)));var s=n[r[e]]||[];s.forEach(function(t){t.tree=n.tree||[],t.tree.push(e+","+a),t.tree=[].concat(_toConsumableArray(new Set(t.tree)))}),t.push.apply(t,s)}),n=t}(t);return n};t.visibleColumnRowMatches=[],t.$watch("_searchQuery",function(e,a){var s=new Set;e&&t.flatItems.forEach(function(n){n._match=!1,new RegExp(String(e).trim().split("").join("(.)*"),"ig").test(n[t.nameKeys[t.nameKeys.length-1]])?(n._match=!0,(n.tree||[]).forEach(function(e){s.add(e)})):n._match=!1}),t.visibleColumnRowMatches=[].concat(_toConsumableArray(s)),n(function(){var e=document.createEvent("MouseEvents");e.initMouseEvent("click");var n=document.getElementById(t.wrapperId).getElementsByClassName("select-panel-list-wrapper")[0].getElementsByClassName("select-panel-list");n=Array.prototype.filter.call(n,function(e){return e.className.indexOf("ng-hide")<0}),Array.prototype.forEach.call(n,function(n,t){setTimeout(function(){var t=n.getElementsByTagName("li");Array.prototype.some.call(t,function(n,t){if(n.className.indexOf("ng-hide")<0)return n.dispatchEvent(e),!0})},80*t)})},100)}),t.rowVisible=function(e,n,a){return!t._searchQuery||(e.hasOwnProperty("_match")?e._match:(e.tree=e.tree||[],t.visibleColumnRowMatches.filter(function(e){return 0==e.indexOf(n+"")}).some(function(n){return e.tree.some(function(e){return n==e})})))},t.toggleMode=function(e){t.selectedItems={},t.cascade=Boolean(e)},t.uncheck=function(e,n){n.stopPropagation(),delete e.checked},t.getColumns=function(e){var n=[];if(n.splice(0,n.length),!e)return n.push(t.flatItems),n;for(var a=0;a<o;a++)n.push(g(a));return n},t.$on("$destory",function(){columns=lastCascade=lastData=lastSelectedItems=null}),t.getSelectedIndex=function(e){return t.selectedItems[e]?t.selectedItems[e]:0},t.clickItem=function(e,n){if(t.selectedItems[e]!=n){var a={};a[e]=Number(n),t.selectedItems=Object.assign({},t.selectedItems,a),Object.keys(t.selectedItems).forEach(function(n){n>e&&delete t.selectedItems[n]})}},t.getCheckedItems=function(){var e=[],n=[];return function(){if(!angular.isArray(t.flatItems))return e;n.splice(0,n.length);var a=t.flatItems.filter(function(e){return e.checked});return n.push.apply(n,a),n}}(),t.getModelValues=function(){return e(s.ngModel)(t.$parent).map(function(e){return e[s.trackBy]}).join(",")};var f=function(n,a){var l=e(s.ngModel)(t.$parent).map(function(e){return e[s.trackBy]});t.flatItems.forEach(function(e){l.indexOf(e[s.trackBy])>=0?e.checked=!0:e.checked=!1}),t.flatItems.length&&c.$setViewValue(t.getCheckedItems())};t.$watchGroup(["getModelValues()","flatItems"],f),t.panelPositionStyle=function(){var e=s.hasOwnProperty("static"),n=180*t.nameKeys.length;return e?{position:"static",width:"100%"}:{position:"absolute",width:t.cascade?n+"px":"300px",zIndex:1e3}}},scope:{data:"=pickItemsFrom"}}}]),angular.module("ck.directives").run(["$templateCache",function(e){e.put("select-panel/template.html",'<div class="select-panel-wrapper" id="{{ wrapperId }}" ng-init="__directiveId = $index" ng-cloak>\n    <div class="select-panel">\n        <p class="select-panel-type" ng-click="noHide($event)">\n            内容标签：\n            <a ng-click="toggleMode(false)" ng-class="{mute: cascade == false}">直接选择</a> \n            <span class="divider"></span>\n            <a ng-click="toggleMode(true)" ng-class="{mute: cascade == true}">级联选择</a>\n        </p>\n        <div class="select-panel-input" ng-click="togglePanelVisiblity($event)">\n            <span class="select-panel-selected-items">\n                <span ng-repeat="tag in getCheckedItems() track by $index">\n                    {{ tag[nameKeys[nameKeys.length-1]] }}\n                    <span class="del-item" ng-click="uncheck(tag, $event)">&times;</span>\n                </span>\n                <span class="placeholder" ng-hide="getCheckedItems().length">\n                    选择标签\n                </span>\n            </span>\n            <div class="arrow-right-wrapper">\n                <span class="arrow-right" ng-hide="staticMode()" ng-class="{active: !searchPanelVisible}"></span>\n            </div>\n        </div>\n        <div class="select-panel-selector" ng-style="panelPositionStyle()" ng-show="searchPanelVisible" ng-click="noHide($event)">\n            <div class="select-panel-search">\n                <input type="text" ng-model="_searchQuery" placeholder="搜索" />\n                <span ng-show="_searchQuery" ng-click="_searchQuery=\'\'" class="reset-query">&times;</span>\n            </div>\n\n            <div class="select-panel-list-wrapper">\n                <ul class="select-panel-list" ng-show="cascade" ng-repeat="column in columns = getColumns(true) track by $index" ng-init="_outerIndex=$index" ng-style="{width: 100/(columns.length || 1) + \'%\'}">\n                    <li ng-repeat="item in column track by $index" \n                        class="select-panel-list-item" \n                        ng-class="{active: (getSelectedIndex(_outerIndex) == $index)&&(_outerIndex != columns.length - 1)}"\n                        ng-click="clickItem(_outerIndex, $index)"\n                        ng-show="rowVisible(item, _outerIndex, $index)"\n                        >\n                        <input ng-model="item.checked" ng-if="_outerIndex == columns.length - 1" id="{{ directiveId + \'_item_\' + _outerIndex + \'_\' + $index }}" type="checkbox" />\n                        <label ng-if="_outerIndex == columns.length - 1" for="{{ directiveId + \'_item_\' + _outerIndex + \'_\' + $index }}">{{ cascade ? item[nameKeys[_outerIndex]] : item[nameKeys[nameKeys.length - 1]] }}</label>\n                        <label ng-if="_outerIndex != columns.length - 1" >{{ cascade ? item[nameKeys[_outerIndex]] : item[nameKeys[nameKeys.length - 1]] }} </label>\n                    </li>\n                </ul>\n                <ul class="select-panel-list" ng-hide="cascade" ng-repeat="column in columns2 = getColumns(false) track by $index" ng-init="_outerIndex=$index" ng-style="{width: 100/(columns2.length || 1) + \'%\'}">\n                    <li ng-repeat="item in column track by $index" \n                        class="select-panel-list-item" \n                        ng-class="{active: (getSelectedIndex(_outerIndex) == $index)&&(_outerIndex != columns2.length - 1)}"\n                        ng-click="clickItem(_outerIndex, $index)"\n                        ng-show="rowVisible(item, _outerIndex, $index)"\n                        >\n                        <input ng-model="item.checked" ng-if="_outerIndex == columns2.length - 1" id="{{ directiveId + \'_item_\' + _outerIndex + \'_\' + $index }}" type="checkbox" />\n                        <label ng-if="_outerIndex == columns2.length - 1" for="{{ directiveId + \'_item_\' + _outerIndex + \'_\' + $index }}">{{ cascade ? item[nameKeys[_outerIndex]] : item[nameKeys[nameKeys.length - 1]] }}</label>\n                        <label ng-if="_outerIndex != columns2.length - 1" >{{ cascade ? item[nameKeys[_outerIndex]] : item[nameKeys[nameKeys.length - 1]] }} </label>\n                    </li>\n                </ul>                \n            </div>\n        </div>\n    </div>\n</div>')}]);