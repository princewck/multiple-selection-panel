"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}angular.module("ck.directives",[]).directive("selectPanel",["$parse","$timeout",function(e,t){return{restrict:"E",require:"ngModel",templateUrl:"select-panel/template.html",link:function(n,a,s,c){n.directiveId=n.$id;var r="true"==s.cascade;n.cascade=r||!1,n.searchPanelVisible=s.hasOwnProperty("static")||!1,n.togglePanelVisiblity=function(e){e.stopPropagation(),s.hasOwnProperty("static")||(n.searchPanelVisible=!n.searchPanelVisible)};var l=function(e){e.stopPropagation(),n.searchPanelVisible&&n.$apply(n.searchPanelVisible=!1)};n.noHide=function(e){e.stopPropagation()},n.staticMode=function(){return s.hasOwnProperty("static")},s.hasOwnProperty("static")||(document.addEventListener("click",l),n.$on("$destory",function(){document.removeEventListener("click",l)}));for(var i=angular.isString(s.arrayKeys)?s.arrayKeys.trim().split("=>"):[],o=i.length+1,u=[],d=0;d<o;d++)u.push("name");n.nameKeys=s.hasOwnProperty("nameKeys")?s.nameKeys.split(","):u;e(s.ngModel)(n.$parent);n.selectedItems={};var m=[],p=n.data,g=function(e){for(var t={},a=p,s=0;s<e;s++){if(!(t=a[n.selectedItems[s]||0]))return m;a=t[i[s]]||m}return a};n.flatItems=[],n.$watch("data",function(e,t){p=angular.copy(e),n.flatItems=h(p)});var h=function(e){for(var t=e,n=0;n<o-1;n++)!function(e){var n=[];t.forEach(function(t,a){t.tree=t.tree||[],t.tree.push(e+","+a),t.tree=[].concat(_toConsumableArray(new Set(t.tree)));var s=t[i[e]]||[];s.forEach(function(n){n.tree=t.tree||[],n.tree.push(e+","+a),n.tree=[].concat(_toConsumableArray(new Set(n.tree)))}),n.push.apply(n,s)}),t=n}(n);return t};n.visibleColumnRowMatches=[],n.$watch("_searchQuery",function(e,a){var s=new Set;e&&n.flatItems.forEach(function(t){t._match=!1,new RegExp(String(e).trim().split("").join("(.)*"),"ig").test(t[n.nameKeys[n.nameKeys.length-1]])?(t._match=!0,(t.tree||[]).forEach(function(e){s.add(e)})):t._match=!1}),n.visibleColumnRowMatches=[].concat(_toConsumableArray(s)),t(function(){var e=document.createEvent("MouseEvents");e.initMouseEvent("click");var t=document.getElementsByClassName("select-panel-list-wrapper")[0].getElementsByClassName("select-panel-list");Array.prototype.forEach.call(t,function(t,n){setTimeout(function(){var n=t.getElementsByTagName("li");Array.prototype.some.call(n,function(t,n){if(t.className.indexOf("ng-hide")<0)return t.dispatchEvent(e),!0})},80*n)})},100)}),n.rowVisible=function(e,t,a){return!n._searchQuery||(e.hasOwnProperty("_match")?e._match:(e.tree=e.tree||[],n.visibleColumnRowMatches.filter(function(e){return 0==e.indexOf(t+"")}).some(function(t){return e.tree.some(function(e){return t==e})})))},n.toggleMode=function(e){n.selectedItems={},n.cascade=Boolean(e)},n.uncheck=function(e,t){t.stopPropagation(),delete e.checked},n.getColumns=function(){var e=[],t=n.cascade,a=[],s=[];return function(){if(t==n.cascade&&a==n.flatItems&&s==n.selectedItems)return e;if(t=n.cascade,a=n.flatItems,s=n.selectedItems,e.splice(0,e.length),!n.cascade)return e.push(n.flatItems),e;for(var c=0;c<o;c++)e.push(g(c));return e}}(),n.$on("$destory",function(){columns=lastCascade=lastData=lastSelectedItems=null}),n.getSelectedIndex=function(e){return n.selectedItems[e]?n.selectedItems[e]:0},n.clickItem=function(e,t){if(n.selectedItems[e]!=t){var a={};a[e]=Number(t),n.selectedItems=Object.assign({},n.selectedItems,a),Object.keys(n.selectedItems).forEach(function(t){t>e&&delete n.selectedItems[t]})}},n.getCheckedItems=function(){var e=[],t=[];return function(){if(!angular.isArray(n.flatItems))return e;t.splice(0,t.length);var a=n.flatItems.filter(function(e){return e.checked});return t.push.apply(t,a),t}}(),n.getModelValues=function(){return e(s.ngModel)(n.$parent).map(function(e){return e[s.trackBy]}).join(",")};var f=function(t,a){var r=e(s.ngModel)(n.$parent).map(function(e){return e[s.trackBy]});n.flatItems.forEach(function(e){r.indexOf(e[s.trackBy])>=0?e.checked=!0:e.checked=!1}),n.flatItems.length&&c.$setViewValue(n.getCheckedItems())};n.$watchGroup(["getModelValues()","flatItems"],f),n.panelPositionStyle=function(){var e=s.hasOwnProperty("static"),t=180*n.nameKeys.length;return e?{position:"static",width:"100%"}:{position:"absolute",width:n.cascade?t+"px":"300px",zIndex:1e3}}},scope:{data:"=pickItemsFrom"}}}]),angular.module("ck.directives").run(["$templateCache",function(e){e.put("select-panel/template.html",'<div class="select-panel-wrapper" ng-init="__directiveId = $index" ng-cloak>\n    <div class="select-panel">\n        <p class="select-panel-type" ng-click="noHide($event)">\n            内容标签：\n            <a ng-click="toggleMode(false)" ng-class="{mute: cascade == false}">直接选择</a> \n            <span class="divider"></span>\n            <a ng-click="toggleMode(true)" ng-class="{mute: cascade == true}">级联选择</a>\n        </p>\n        <div class="select-panel-input" ng-click="togglePanelVisiblity($event)">\n            <span class="select-panel-selected-items">\n                <span ng-repeat="tag in getCheckedItems() track by $index">\n                    {{ tag[nameKeys[nameKeys.length-1]] }}\n                    <span class="del-item" ng-click="uncheck(tag, $event)">&times;</span>\n                </span>\n                <span class="placeholder" ng-hide="getCheckedItems().length">\n                    选择标签\n                </span>\n            </span>\n            <div class="arrow-right-wrapper">\n                <span class="arrow-right" ng-hide="staticMode()" ng-class="{active: !searchPanelVisible}"></span>\n            </div>\n        </div>\n        <div class="select-panel-selector" ng-style="panelPositionStyle()" ng-show="searchPanelVisible" ng-click="noHide($event)">\n            <div class="select-panel-search">\n                <input type="text" ng-model="_searchQuery" placeholder="搜索" />\n                <span ng-show="_searchQuery" ng-click="_searchQuery=\'\'" class="reset-query">&times;</span>\n            </div>\n\n            <div class="select-panel-list-wrapper">\n                <ul class="select-panel-list" ng-repeat="column in getColumns() track by $index" ng-init="_outerIndex=$index" ng-style="{width: 100/(getColumns().length || 1) + \'%\'}">\n                    <li ng-repeat="item in column track by $index" \n                        class="select-panel-list-item" \n                        ng-class="{active: (getSelectedIndex(_outerIndex) == $index)&&(_outerIndex != getColumns().length - 1)}"\n                        ng-click="clickItem(_outerIndex, $index)"\n                        ng-show="rowVisible(item, _outerIndex, $index)"\n                        >\n                        <input ng-model="item.checked" ng-if="_outerIndex == getColumns().length - 1" id="{{ directiveId + \'_item_\' + _outerIndex + \'_\' + $index }}" type="checkbox" />\n                        <label ng-if="_outerIndex == getColumns().length - 1" for="{{ directiveId + \'_item_\' + _outerIndex + \'_\' + $index }}">{{ cascade ? item[nameKeys[_outerIndex]] : item[nameKeys[nameKeys.length - 1]] }}</label>\n                        <label ng-if="_outerIndex != getColumns().length - 1" >{{ cascade ? item[nameKeys[_outerIndex]] : item[nameKeys[nameKeys.length - 1]] }} </label>\n                    </li>\n                </ul>\n            </div>\n        </div>\n    </div>\n</div>')}]);